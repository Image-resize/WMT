<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Money Transfer (WMT)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- ### নতুন যুক্ত করা হয়েছে: QR Code Scanner Library ### -->
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1a73e8;
            --secondary: #34a853;
            --accent: #fbbc05;
            --danger: #ea4335;
            --light: #f8f9fa;
            --dark: #202124;
            --gray: #5f6368;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Auth Pages */
        .auth-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a73e8 0%, #34a853 100%);
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            padding: 30px;
            transition: transform 0.3s ease;
        }

        .auth-card:hover {
            transform: translateY(-5px);
        }

        .logo {
            text-align: center;
            margin-bottom: 25px;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            color: var(--gray);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: #1669d6;
            transform: translateY(-2px);
        }

        .btn.loading {
            color: transparent;
            cursor: not-allowed;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: btn-loader 1s ease infinite;
        }

        @keyframes btn-loader {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }


        .btn-secondary { background: var(--secondary); }
        .btn-secondary:hover { background: #2d9355; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #d33223; }

        .auth-links {
            text-align: center;
            margin-top: 20px;
        }

        .auth-links a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-links a:hover { text-decoration: underline; }

        .profile-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            margin: 0 auto 15px;
            display: block;
            background-color: #e8f0fe;
        }

        .upload-btn {
            background: var(--light);
            color: var(--dark);
            border: 1px dashed var(--gray);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #e8f0fe;
            border-color: var(--primary);
        }

        .home-container { display: none; }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
        }

        .menu-toggle {
            font-size: 24px;
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-toggle:hover { color: var(--primary); }
        .app-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-img-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 200;
            transition: all 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar.active { left: 0; }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            display: none;
        }

        .sidebar-overlay.active { display: block; }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .sidebar-close { font-size: 24px; color: var(--dark); cursor: pointer; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li { margin-bottom: 10px; }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #e8f0fe;
            color: var(--primary);
        }
        .sidebar-menu a.kyc-verified-link {
            color: var(--secondary);
            pointer-events: none; /* Make it unclickable */
        }
        .sidebar-menu i { font-size: 20px; width: 24px; text-align: center; }

        .main-content { padding: 20px 0; }
        .page { display: none; }
        .page.active { display: block; }

        .welcome-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 12px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
        }
        .welcome-section h2 { font-size: 24px; margin-bottom: 10px; }

        .balance-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 25px;
        }
        .balance-card h3 { color: var(--gray); font-size: 16px; margin-bottom: 10px; }
        .balance-amount { font-size: 32px; font-weight: 700; color: var(--dark); }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .service-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .service-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 20px;
            color: white;
        }
        .add-money .service-icon { background: var(--primary); }
        .send-money .service-icon { background: var(--secondary); }
        .money-out .service-icon { background: var(--accent); }
        .payment .service-icon { background: var(--danger); }
        .bill-pay .service-icon { background: #673ab7; }
        .service-card h4 { font-size: 14px; color: var(--dark); }

        .transactions-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .section-header h3 { font-size: 18px; color: var(--dark); }
        .view-all { color: var(--primary); text-decoration: none; font-weight: 500; font-size: 14px; }
        .transaction-list { list-style: none; }
        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { display: flex; align-items: center; gap: 15px; }
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        .transaction-details h4 { font-size: 16px; margin-bottom: 5px; }
        .transaction-details p { font-size: 14px; color: var(--gray); }
        .transaction-amount { font-weight: 600; }
        .credit { color: var(--secondary); }
        .debit { color: var(--danger); }

        .form-page {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        .form-page h2 { margin-bottom: 20px; color: var(--dark); font-size: 22px; }

        .user-id-section {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .user-id-section h4 { color: var(--secondary); margin-bottom: 10px; }
        .user-id-display { display: flex; gap: 10px; margin-top: 10px; }
        .user-id-display input {
            flex: 1;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #f9f9f9;
        }
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 15px;
            cursor: pointer;
        }

        .message-box {
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        .message-box.success { background: #e8f5e9; border: 1px solid #c8e6c9; }
        .message-box.error { background: #fdecea; border: 1px solid #f5c6cb; }
        .message-icon { font-size: 50px; margin-bottom: 15px; }
        .message-icon.success { color: var(--secondary); }
        .message-icon.error { color: var(--danger); }

        .fee-display {
            background-color: #f0f4f8;
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--gray);
            text-align: center;
        }

        .kyc-status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .kyc-verified {
            background-color: #e8f5e9;
            color: var(--secondary);
            border: 1px solid #a5d6a7;
        }

        .kyc-not-verified {
            background-color: #fdecea;
            color: var(--danger);
            border: 1px solid #f5c6cb;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 400px;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            color: var(--gray);
            cursor: pointer;
            font-weight: bold;
        }
        #modal-qrcode-container img {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        
        /* ### নতুন যুক্ত করা হয়েছে: QR Scanner Modal Style ### */
        #qr-scanner-modal .modal-content {
            width: 500px;
            max-width: 95%;
        }
        #qr-reader {
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .services-grid { grid-template-columns: repeat(3, 1fr); }
            .auth-card { padding: 20px; }
        }

        @media (max-width: 576px) {
            .services-grid { grid-template-columns: repeat(2, 1fr); }
            .balance-amount { font-size: 28px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="auth-container" id="login-page">
        <div class="auth-card">
            <div class="logo"><h1>WMT</h1><p>Web Money Transfer</p></div>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Gmail</label><input type="email" class="form-control" id="login-email" placeholder="your.email@gmail.com" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" class="form-control" id="login-password" placeholder="Enter your password" required></div>
                <button type="submit" class="btn" id="login-btn">Login</button>
            </form>
            <div class="auth-links"><p>Don't have an account? <a href="#" id="go-to-signup">Sign Up</a></p></div>
        </div>
    </div>

    <!-- Signup Page -->
    <div class="auth-container" id="signup-page" style="display: none;">
        <div class="auth-card">
            <div class="logo"><h1>WMT</h1><p>Web Money Transfer</p></div>
            <form id="signup-form">
                <div class="profile-upload">
                    <img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-image" id="profile-preview">
                    <input type="file" id="image-upload" accept="image/*" style="display: none;">
                    <button type="button" class="upload-btn" id="upload-btn">Upload Profile Image</button>
                </div>
                <div class="form-group"><label for="name">Full Name</label><input type="text" class="form-control" id="name" placeholder="Enter your full name" required></div>
                <div class="form-group"><label for="dob">Date of Birth</label><input type="date" class="form-control" id="dob" required></div>
                <div class="form-group"><label for="email">Gmail</label><input type="email" class="form-control" id="email" placeholder="your.email@gmail.com" required></div>
                <div class="form-group"><label for="gender">Gender</label><select class="form-control" id="gender" required><option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
                <div class="form-group"><label for="password">Password (Minimum 6 characters)</label><input type="password" class="form-control" id="password" placeholder="Create a password" minlength="6" required></div>
                <button type="submit" class="btn btn-secondary" id="signup-btn">Sign Up</button>
            </form>
            <div class="auth-links"><p>Already have an account? <a href="#" id="go-to-login">Login</a></p></div>
        </div>
    </div>

    <!-- Home Page -->
    <div class="home-container" id="home-page">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></div>
                    <div class="app-name">WMT</div>
                    <div class="profile-header"><img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-img-small" id="header-profile-img"></div>
                </div>
            </div>
        </header>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header"><h3>Menu</h3><div class="sidebar-close" id="sidebar-close"><i class="fas fa-times"></i></div></div>
            <ul class="sidebar-menu">
                <li><a href="#" class="sidebar-link active" data-page="home"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" class="sidebar-link" data-page="wallet"><i class="fas fa-wallet"></i> Wallet</a></li>
                <li><a href="#" class="sidebar-link" data-page="transactions"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
                <!-- ### পরিবর্তিত: KYC Link এ ID যোগ করা হয়েছে ### -->
                <li><a href="#" class="sidebar-link" data-page="kyc" id="sidebar-kyc-link"><i class="fas fa-user-check"></i> KYC Verify</a></li>
                <li><a href="#" class="sidebar-link" data-page="profile"><i class="fas fa-user"></i> Profile</a></li>
                <li><a href="#" class="sidebar-link" data-page="settings"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <main class="main-content">
            <div class="container">
                <div class="page active" id="home-content">
                    <div class="welcome-section"><h2>Hello, <span id="user-name">User</span>!</h2><p>Welcome to Web Money Transfer</p></div>
                    <div id="home-kyc-status"></div>
                    <!-- ### পরিবর্তিত: এই কার্ডটি এখন শর্তসাপেক্ষে হাইড হবে ### -->
                    <div class="balance-card" id="home-balance-card"><h3>Current Balance</h3><div class="balance-amount">$<span id="balance-amount">0.00</span></div></div>
                    <div class="services-grid">
                        <div class="service-card add-money" data-service="add-money"><div class="service-icon"><i class="fas fa-plus"></i></div><h4>Add Money</h4></div>
                        <div class="service-card send-money" data-service="send-money"><div class="service-icon"><i class="fas fa-paper-plane"></i></div><h4>Send Money</h4></div>
                        <div class="service-card money-out" data-service="money-out"><div class="service-icon"><i class="fas fa-money-bill-wave"></i></div><h4>Money Out</h4></div>
                        <div class="service-card payment" data-service="payment"><div class="service-icon"><i class="fas fa-credit-card"></i></div><h4>Payment</h4></div>
                        <div class="service-card bill-pay" data-service="bill-pay"><div class="service-icon"><i class="fas fa-file-invoice-dollar"></i></div><h4>Bill Pay</h4></div>
                    </div>
                    <div class="transactions-section">
                        <div class="section-header"><h3>Recent Transactions</h3><a href="#" class="view-all" id="view-all-transactions">View All</a></div>
                        <ul class="transaction-list" id="recent-transactions"></ul>
                    </div>
                </div>

                <div class="page" id="wallet-content">
                    <div class="form-page">
                        <h2>My Wallet</h2>
                        <div class="balance-card"><h3>Available Balance</h3><div class="balance-amount">$<span id="wallet-balance">0.00</span></div></div>
                        <div class="user-id-section">
                            <h4>Your Unique User ID</h4><p>Use this ID to receive money from other WMT users.</p>
                            <div class="user-id-display"><input type="text" id="wallet-user-id" value="WMT12345" readonly><button class="copy-btn" onclick="copyText('wallet-user-id')">Copy</button></div>
                        </div>
                    </div>
                </div>

                <div class="page" id="transactions-content">
                    <div class="form-page"><h2>Transaction History</h2><div class="transactions-section"><ul class="transaction-list" id="all-transactions"></ul></div></div>
                </div>

                <div class="page" id="kyc-content">
                    <div class="form-page">
                        <h2>KYC Verification</h2>
                        <div id="kyc-status-page"></div>
                        <div id="kyc-form-section">
                            <p>Please enter the verification code provided by the admin to verify your account.</p>
                            <div class="form-group" style="margin-top: 20px;"><label for="kyc-code">Verification Code</label><input type="text" class="form-control" id="kyc-code" placeholder="Enter verification code from admin"></div>
                            <button class="btn" id="kyc-submit-btn">Submit Code</button>
                            <div id="kyc-message" class="message-box"></div>
                        </div>
                    </div>
                </div>

                <div class="page" id="profile-content">
                    <div class="form-page">
                        <h2>My Profile</h2>
                        <div class="profile-upload"><img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-image" id="profile-image-view"></div>
                        <button class="btn btn-secondary" id="show-qr-btn" style="margin-bottom: 20px;"><i class="fas fa-qrcode"></i> Show MY QR Code</button>
                        <div class="form-group"><label>Full Name</label><div class="form-control" style="background: #f9f9f9;" id="profile-name"></div></div>
                        <div class="form-group">
                            <label>User ID</label>
                            <div class="user-id-display"><input type="text" class="form-control" id="profile-user-id" value="WMT12345" readonly><button class="copy-btn" onclick="copyText('profile-user-id')">Copy</button></div>
                        </div>
                        <div class="form-group"><label>Email</label><div class="form-control" style="background: #f9f9f9;" id="profile-email"></div></div>
                        <div class="form-group"><label>Date of Birth</label><div class="form-control" style="background: #f9f9f9;" id="profile-dob"></div></div>
                    </div>
                </div>

                <div class="page" id="settings-content">
                    <div class="form-page">
                        <h2>Settings</h2>
                        <div class="profile-upload">
                            <img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-image" id="settings-profile-preview">
                            <input type="file" id="settings-image-upload" accept="image/*" style="display: none;">
                            <button type="button" class="upload-btn" id="settings-upload-btn">Change Profile Image</button>
                        </div>
                        <div class="form-group"><label for="settings-name">Full Name</label><input type="text" class="form-control" id="settings-name"></div>
                        <div class="form-group"><label for="settings-dob">Date of Birth</label><input type="date" class="form-control" id="settings-dob"></div>
                        <button class="btn" id="save-settings-btn">Save Basic Info</button>
                        <hr style="margin: 25px 0; border: 1px solid #f0f0f0;">
                        <h3>Change Password</h3>
                        <div class="form-group"><label for="current-password">Current Password</label><input type="password" class="form-control" id="current-password" placeholder="Enter your current password"></div>
                        <div class="form-group"><label for="new-password">New Password</label><input type="password" class="form-control" id="new-password" placeholder="Enter new password (min. 6 characters)"></div>
                        <button class="btn btn-secondary" id="change-password-btn">Change Password</button>
                    </div>
                </div>

                <div class="page" id="add-money-content">
                    <div class="form-page">
                        <h2>Add Money</h2>
                        <div class="form-group"><label for="redeem-code">Redeem Code</label><input type="text" class="form-control" id="redeem-code" placeholder="Enter redeem code from admin"></div>
                        <div class="form-group"><label for="redeem-password">Code Password</label><input type="password" class="form-control" id="redeem-password" placeholder="Enter password for the code"></div>
                        <button class="btn" id="redeem-btn">Redeem Code</button>
                        <div id="redeem-message" class="message-box"></div>
                    </div>
                </div>

                <div class="page" id="send-money-content">
                    <div class="form-page">
                        <h2>Send Money</h2>
                        <form id="send-money-form">
                            <div class="form-group">
                                <label for="recipient-id">Recipient User ID</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" id="recipient-id" placeholder="Enter recipient's WMT ID" required>
                                    <button type="button" class="btn" id="scan-qr-send" style="width: auto;"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </div>
                            <!-- ### পরিবর্তিত: Placeholder এবং Amount সীমা পরিবর্তন করা হয়েছে ### -->
                            <div class="form-group"><label for="send-amount">Amount ($)</label><input type="number" step="0.01" class="form-control" id="send-amount" placeholder="Min $0.01, Max $500" required></div>
                            <div class="fee-display" id="send-fee-display" style="display: none;"></div>
                            <div class="form-group" style="margin-top: 20px;"><label for="send-password">Your Password</label><input type="password" class="form-control" id="send-password" placeholder="Enter your password to confirm" required></div>
                            <button type="submit" class="btn" id="send-money-btn">Send Money</button>
                        </form>
                        <div id="send-money-message" class="message-box"></div>
                    </div>
                </div>

                <div class="page" id="money-out-content">
                    <div class="form-page">
                        <h2>Money Out</h2>
                        <form id="money-out-form">
                           <div class="form-group">
                                <label for="agent-id">Agent User ID</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" id="agent-id" placeholder="Enter Agent's AWMT ID" required>
                                    <button type="button" class="btn" id="scan-qr-out" style="width: auto;"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </div>
                            <div class="form-group"><label for="money-out-amount">Amount ($)</label><input type="number" step="0.01" class="form-control" id="money-out-amount" placeholder="Enter amount to cash out" required></div>
                            <div class="fee-display" id="money-out-fee-display" style="display: none;"></div>
                            <div class="form-group" style="margin-top: 20px;"><label for="money-out-password">Your Password</label><input type="password" class="form-control" id="money-out-password" placeholder="Enter your password to confirm" required></div>
                            <button type="submit" class="btn" id="money-out-btn">Money Out</button>
                        </form>
                         <div id="money-out-message" class="message-box"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- QR Code Modal -->
    <div class="modal-overlay" id="qr-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h3>Scan to Pay Me</h3>
            <div id="modal-qrcode-container"></div>
            <p style="margin-top: 10px; color: var(--gray);">Your User ID: <strong id="modal-user-id"></strong></p>
        </div>
    </div>
    
    <!-- ### নতুন যুক্ত করা হয়েছে: QR Code Scanner Modal ### -->
    <div class="modal-overlay" id="qr-scanner-modal">
        <div class="modal-content">
            <span class="modal-close" id="qr-scanner-close-btn">&times;</span>
            <h3>Scan QR Code</h3>
            <div id="qr-reader" style="width: 100%;"></div>
        </div>
    </div>


    <script>
    // --- START OF SCRIPT ---
    
    const firebaseConfig = {
      apiKey: "AIzaSyAzU36v8dZ1jEMh1qxEAnNxDRAmoRCVbwY",
      authDomain: "wmt-services.firebaseapp.com",
      databaseURL: "https://wmt-services-default-rtdb.firebaseio.com",
      projectId: "wmt-services",
      storageBucket: "wmt-services.firebasestorage.app",
      messagingSenderId: "935651931226",
      appId: "1:935651931226:web:5c412bd299f215c14f5463",
      measurementId: "G-6NTS4GW1DK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null; 
    let signupProfileUrl = 'https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png'; 

    const allPages = ['login-page', 'signup-page', 'home-page'];
    const pages = document.querySelectorAll('.page');
    
    // ### নতুন যুক্ত করা হয়েছে: QR Scanner এর জন্য ভেরিয়েবল ###
    let html5QrCodeScanner = null;
    let activeQrInputId = null;
    
    function showMainContainer(pageId) {
        allPages.forEach(p => {
            const el = document.getElementById(p);
            if (p === pageId) {
                el.style.display = (p === 'home-page') ? 'block' : 'flex';
            } else {
                el.style.display = 'none';
            }
        });
    }

    function toggleButtonLoading(btn, isLoading) {
        if (isLoading) {
            btn.classList.add('loading');
            btn.disabled = true;
        } else {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }
    
    // --- Event Listeners for Page Navigation ---
    document.getElementById('go-to-signup').addEventListener('click', (e) => { e.preventDefault(); showMainContainer('signup-page'); });
    document.getElementById('go-to-login').addEventListener('click', (e) => { e.preventDefault(); showMainContainer('login-page'); });
    document.getElementById('menu-toggle').addEventListener('click', () => { 
        document.getElementById('sidebar').classList.add('active'); 
        document.getElementById('sidebar-overlay').classList.add('active'); 
    });
    const closeSidebar = () => {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebar-overlay').classList.remove('active');
    };
    document.getElementById('sidebar-close').addEventListener('click', closeSidebar);
    document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = link.getAttribute('data-page');
            if (page) {
                navigateTo(page);
                closeSidebar();
            }
        });
    });
    
    document.querySelectorAll('.service-card').forEach(card => {
        card.addEventListener('click', () => {
            if (currentUser && !currentUser.isKycVerified) {
                alert("Please complete KYC verification to use any services.");
                navigateTo('kyc');
                return;
            }
            const service = card.getAttribute('data-service');
            const pageMap = { 'add-money': 'add-money', 'send-money': 'send-money', 'money-out': 'money-out' };
            if (pageMap[service]) {
                navigateTo(pageMap[service]);
            } else {
                alert(`${service} feature is under development!`);
            }
        });
    });

    document.getElementById('view-all-transactions').addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('transactions');
    });
    
    // --- Navigation and History Management ---
    function navigateTo(pageId) {
        showPage(pageId);
        if (window.location.hash !== `#${pageId}`) {
            history.pushState({ page: pageId }, '', `#${pageId}`);
        }
    }

    function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(`${pageId}-content`);
        if (targetPage) targetPage.classList.add('active');
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-page="${pageId}"]`);
        if(activeLink) activeLink.classList.add('active');
    }

    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.page) {
            showPage(event.state.page);
        } else {
            const hashPage = window.location.hash.substring(1);
            showPage(hashPage || 'home');
        }
    });

    // --- Authentication ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    currentUser = { uid: user.uid, ...doc.data() };
                    if (!document.getElementById('home-page').style.display || document.getElementById('home-page').style.display === 'none') {
                        initializeAppUI();
                    } else {
                        updateAllUI();
                    }
                } else {
                    console.error("User data not found in Firestore!");
                    auth.signOut();
                }
            }, error => {
                console.error("Error fetching user data:", error);
                auth.signOut();
            });
        } else {
            currentUser = null;
            showMainContainer('login-page');
            history.replaceState(null, '', window.location.pathname);
            document.getElementById('login-form').reset();
        }
    });

    document.getElementById('signup-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const signupBtn = document.getElementById('signup-btn');
        toggleButtonLoading(signupBtn, true);
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value.toLowerCase();
        const password = document.getElementById('password').value;
        const dob = document.getElementById('dob').value;
        const gender = document.getElementById('gender').value;
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                const newUserId = `WMT${Date.now() % 100000 + Math.floor(Math.random() * 1000)}`;
                db.collection('users').doc(user.uid).set({
                    userId: newUserId, name, email, dob, gender,
                    balance: 0.00, profileImg: signupProfileUrl, isKycVerified: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => alert("Signup successful!"))
                  .catch((error) => alert("Error saving user data: " + error.message))
                  .finally(() => toggleButtonLoading(signupBtn, false));
            })
            .catch((error) => {
                alert("Signup failed: " + error.message);
                toggleButtonLoading(signupBtn, false);
            });
    });

    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const loginBtn = document.getElementById('login-btn');
        toggleButtonLoading(loginBtn, true);
        const email = document.getElementById('login-email').value.toLowerCase();
        const password = document.getElementById('login-password').value;
        auth.signInWithEmailAndPassword(email, password)
            .catch((error) => alert('Invalid email or password. Error: ' + error.message))
            .finally(() => toggleButtonLoading(loginBtn, false));
    });
    
    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        auth.signOut().then(closeSidebar);
    });
    
    function initializeAppUI() {
        if (!currentUser) return;
        showMainContainer('home-page');
        const initialPage = window.location.hash ? window.location.hash.substring(1) : 'home';
        showPage(initialPage);
        history.replaceState({ page: initialPage }, '', `#${initialPage}`);
        updateAllUI();
    }

    function updateAllUI() {
        if (!currentUser) return;
        const formattedBalance = currentUser.balance.toFixed(2);
        document.getElementById('balance-amount').textContent = formattedBalance;
        document.getElementById('wallet-balance').textContent = formattedBalance;
        document.getElementById('user-name').textContent = currentUser.name.split(' ')[0];
        document.getElementById('header-profile-img').src = currentUser.profileImg;
        document.getElementById('profile-name').textContent = currentUser.name;
        document.getElementById('profile-email').textContent = currentUser.email;
        document.getElementById('profile-dob').textContent = currentUser.dob;
        document.getElementById('profile-image-view').src = currentUser.profileImg;
        document.getElementById('profile-user-id').value = currentUser.userId;
        document.getElementById('wallet-user-id').value = currentUser.userId;
        document.getElementById('settings-name').value = currentUser.name;
        document.getElementById('settings-dob').value = currentUser.dob;
        document.getElementById('settings-profile-preview').src = currentUser.profileImg;
        updateKycStatusUI();
        loadTransactions();
    }
    
    // ### পরিবর্তিত ফাংশন: KYC Status UI আপডেট ###
    function updateKycStatusUI() {
        const homeKycStatus = document.getElementById('home-kyc-status');
        const pageKycStatus = document.getElementById('kyc-status-page');
        const kycForm = document.getElementById('kyc-form-section');
        const homeBalanceCard = document.getElementById('home-balance-card');
        const sidebarKycLink = document.getElementById('sidebar-kyc-link');
        
        homeKycStatus.innerHTML = '';
        pageKycStatus.innerHTML = '';

        if (currentUser.isKycVerified) {
            const verifiedHTML = `<div class="kyc-status kyc-verified"><i class="fas fa-check-circle"></i> KYC Verified</div>`;
            // pageKycStatus শুধুমাত্র KYC পেজে দেখানো হবে
            pageKycStatus.innerHTML = verifiedHTML;
            kycForm.style.display = 'none';

            // হোম পেজ থেকে KYC ব্যানার এবং ব্যালেন্স কার্ড হাইড করা
            homeKycStatus.style.display = 'none';
            homeBalanceCard.style.display = 'none';

            // সাইডবার মেনু টেক্সট পরিবর্তন করা
            sidebarKycLink.innerHTML = `<i class="fas fa-check-circle"></i> KYC Verified`;
            sidebarKycLink.classList.add('kyc-verified-link');
            
        } else {
            const notVerifiedHTML = `<div class="kyc-status kyc-not-verified"><i class="fas fa-exclamation-triangle"></i> KYC Not Verified. Please verify to transact.</div>`;
            homeKycStatus.innerHTML = notVerifiedHTML;
            pageKycStatus.innerHTML = notVerifiedHTML;
            homeKycStatus.style.display = 'block';
            homeBalanceCard.style.display = 'block';
            kycForm.style.display = 'block';

            // সাইডবার মেনু টেক্সট আগের মতো রাখা
            sidebarKycLink.innerHTML = `<i class="fas fa-user-check"></i> KYC Verify`;
            sidebarKycLink.classList.remove('kyc-verified-link');
        }
    }
    
    // All other functions like transactions, image upload, etc. remain the same as before.
    async function addTransaction(uid, type, amount, description, icon) { if (!uid) return; const transaction = { type, amount, description, icon, date: firebase.firestore.Timestamp.now() }; await db.collection('users').doc(uid).collection('transactions').add(transaction); }
    function loadTransactions() { if (!currentUser) return; db.collection('users').doc(currentUser.uid).collection('transactions').orderBy('date', 'desc').limit(20).onSnapshot(querySnapshot => { document.getElementById('recent-transactions').innerHTML = ''; document.getElementById('all-transactions').innerHTML = ''; let index = 0; querySnapshot.forEach(doc => { const tx = doc.data(); const readableDate = tx.date.toDate().toLocaleString(); const txElement = createTransactionElement(tx, readableDate); document.getElementById('all-transactions').appendChild(txElement.cloneNode(true)); if (index < 5) { document.getElementById('recent-transactions').appendChild(txElement); } index++; }); }); }
    function createTransactionElement(tx, date) { const li = document.createElement('li'); li.className = 'transaction-item'; const isCredit = tx.type === 'credit'; const color = isCredit ? 'var(--secondary)' : 'var(--danger)'; const sign = isCredit ? '+' : '-'; li.innerHTML = `<div class="transaction-info"><div class="transaction-icon" style="background-color: ${color};"><i class="fas ${tx.icon}"></i></div><div class="transaction-details"><h4>${tx.description}</h4><p>${date}</p></div></div><div class="transaction-amount ${tx.type}">${sign}$${tx.amount.toFixed(2)}</div>`; return li; }
    document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('image-upload').click()); document.getElementById('settings-upload-btn').addEventListener('click', () => document.getElementById('settings-image-upload').click());
    document.getElementById('image-upload').addEventListener('change', (e) => { const file = e.target.files[0]; if(file) handleImageUpload(file, document.getElementById('profile-preview'), (url) => { signupProfileUrl = url; }); });
    document.getElementById('settings-image-upload').addEventListener('change', (e) => { const file = e.target.files[0]; if(file) handleImageUpload(file, document.getElementById('settings-profile-preview'), async (url) => { await db.collection('users').doc(currentUser.uid).update({ profileImg: url }); alert("Profile image updated successfully!"); }); });
    async function handleImageUpload(file, previewElement, callback) { const cloudName = 'dntvrm1wn'; const uploadPreset = 'ml_default'; const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`; const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', uploadPreset); previewElement.src = "https://i.gifer.com/ZZ5H.gif"; try { const response = await fetch(url, { method: 'POST', body: formData }); const data = await response.json(); if (data.secure_url) { previewElement.src = data.secure_url; callback(data.secure_url); } else { throw new Error('Image upload failed'); } } catch (error) { alert('Error uploading image. Please try again.'); previewElement.src = 'https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png'; } }

    // --- (UPDATED) KYC Verification Logic ---
    document.getElementById('kyc-submit-btn').addEventListener('click', async () => {
        const kycBtn = document.getElementById('kyc-submit-btn');
        const codeInput = document.getElementById('kyc-code').value.trim().toUpperCase();
        const messageBox = document.getElementById('kyc-message');
        if (!codeInput) { showMessage(messageBox, 'error', 'Please enter a verification code.'); return; }
        toggleButtonLoading(kycBtn, true);
        try {
            const kycCodesRef = db.collection('kyc_codes');
            const querySnapshot = await kycCodesRef.where('code', '==', codeInput).limit(1).get();
            if (querySnapshot.empty) {
                showMessage(messageBox, 'error', 'Invalid KYC code. Please check the code and try again.');
                toggleButtonLoading(kycBtn, false); return;
            }
            const kycDoc = querySnapshot.docs[0];
            const kycData = kycDoc.data();
            if (kycData.isUsed) {
                showMessage(messageBox, 'error', 'This KYC code has already been used.');
                toggleButtonLoading(kycBtn, false); return;
            }
            const userRef = db.collection('users').doc(currentUser.uid);
            const kycDocRef = kycDoc.ref;
            await db.runTransaction(async (transaction) => {
                transaction.update(userRef, { isKycVerified: true });
                transaction.update(kycDocRef, { 
                    isUsed: true, 
                    usedBy: currentUser.uid,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            showMessage(messageBox, 'success', 'Congratulations! Your KYC verification is successful.');
        } catch (error) {
            console.error("KYC Verification Error: ", error);
            showMessage(messageBox, 'error', 'An error occurred during verification. Please try again.');
        } finally {
            toggleButtonLoading(kycBtn, false);
        }
    });

    // All other feature logics like redeem code, send money, etc. remain the same.
    let mockRedeemCodes = [ { code: "WMTPROMO50", password: "pass", amount: 50, used: false, expiry: new Date('2025-12-31T23:59:59') }, { code: "WMTBONUS10", password: "123", amount: 10, used: false, expiry: new Date('2025-12-31T23:59:59') }, ];
    document.getElementById('redeem-btn').addEventListener('click', async () => { const redeemBtn = document.getElementById('redeem-btn'); const code = document.getElementById('redeem-code').value.trim(); const password = document.getElementById('redeem-password').value; const messageBox = document.getElementById('redeem-message'); if (!code || !password) { showMessage(messageBox, 'error', 'Please enter both code and password.'); return; } toggleButtonLoading(redeemBtn, true); const redeemData = mockRedeemCodes.find(c => c.code === code); if (!redeemData || redeemData.password !== password) { showMessage(messageBox, 'error', 'Invalid code or password.'); toggleButtonLoading(redeemBtn, false); return; } if (redeemData.used) { showMessage(messageBox, 'error', 'This code has been used.'); toggleButtonLoading(redeemBtn, false); return; } if (new Date() > redeemData.expiry) { showMessage(messageBox, 'error', 'This code has expired.'); toggleButtonLoading(redeemBtn, false); return; } redeemData.used = true; const newBalance = currentUser.balance + redeemData.amount; await db.collection('users').doc(currentUser.uid).update({ balance: newBalance }); await addTransaction(currentUser.uid, 'credit', redeemData.amount, `Redeemed Code`, 'fa-plus-circle'); showMessage(messageBox, 'success', `Successfully redeemed $${redeemData.amount.toFixed(2)}.`); document.getElementById('redeem-code').value = ''; document.getElementById('redeem-password').value = ''; toggleButtonLoading(redeemBtn, false); });
    const sendAmountInput = document.getElementById('send-amount'); const sendFeeDisplay = document.getElementById('send-fee-display'); const SEND_MONEY_FEE = 0.05; sendAmountInput.addEventListener('input', () => { const amount = parseFloat(sendAmountInput.value); if (amount > 0) { sendFeeDisplay.textContent = `Fee: $${SEND_MONEY_FEE.toFixed(2)}. Total: $${(amount + SEND_MONEY_FEE).toFixed(2)}`; sendFeeDisplay.style.display = 'block'; } else { sendFeeDisplay.style.display = 'none'; } });
    
    // ### পরিবর্তিত: Send Money Validation লজিক ###
    document.getElementById('send-money-form').addEventListener('submit', async (e) => { e.preventDefault(); const sendBtn = document.getElementById('send-money-btn'); const recipientId = document.getElementById('recipient-id').value; const amount = parseFloat(sendAmountInput.value); const password = document.getElementById('send-password').value; const messageBox = document.getElementById('send-money-message'); if (amount < 0.01 || amount > 500) { showMessage(messageBox, 'error', 'Amount must be between $0.01 and $500.'); return; } toggleButtonLoading(sendBtn, true); try { await auth.signInWithEmailAndPassword(currentUser.email, password); } catch (error) { showMessage(messageBox, 'error', 'Incorrect password.'); toggleButtonLoading(sendBtn, false); return; } const totalDeduction = amount + SEND_MONEY_FEE; if (recipientId === currentUser.userId) { showMessage(messageBox, 'error', 'You cannot send to yourself.'); toggleButtonLoading(sendBtn, false); return; } if (totalDeduction > currentUser.balance) { showMessage(messageBox, 'error', `Insufficient balance.`); toggleButtonLoading(sendBtn, false); return; } const usersRef = db.collection('users'); const recipientQuery = await usersRef.where('userId', '==', recipientId).limit(1).get(); if (recipientQuery.empty) { showMessage(messageBox, 'error', 'Recipient not found.'); toggleButtonLoading(sendBtn, false); return; } const recipientDoc = recipientQuery.docs[0]; const recipient = { uid: recipientDoc.id, ...recipientDoc.data() }; try { await db.runTransaction(async (transaction) => { const senderDocRef = usersRef.doc(currentUser.uid); const recipientDocRef = usersRef.doc(recipient.uid); transaction.update(senderDocRef, { balance: firebase.firestore.FieldValue.increment(-totalDeduction) }); transaction.update(recipientDocRef, { balance: firebase.firestore.FieldValue.increment(amount) }); }); await addTransaction(currentUser.uid, 'debit', amount, `Sent to ${recipient.name}`, 'fa-paper-plane'); await addTransaction(currentUser.uid, 'debit', SEND_MONEY_FEE, 'Send Money Fee', 'fa-file-invoice-dollar'); await addTransaction(recipient.uid, 'credit', amount, `Received from ${currentUser.name}`, 'fa-download'); showMessage(messageBox, 'success', `Sent $${amount.toFixed(2)} to ${recipient.name}.`); document.getElementById('send-money-form').reset(); } catch (error) { showMessage(messageBox, 'error', 'Transaction failed: ' + error); } finally { toggleButtonLoading(sendBtn, false); } });
    const moneyOutAmountInput = document.getElementById('money-out-amount'); const moneyOutFeeDisplay = document.getElementById('money-out-fee-display'); const MONEY_OUT_FEE_PERCENT = 0.01; moneyOutAmountInput.addEventListener('input', () => { const amount = parseFloat(moneyOutAmountInput.value); if (amount > 0) { const fee = amount * MONEY_OUT_FEE_PERCENT; moneyOutFeeDisplay.textContent = `Fee (1%): $${fee.toFixed(2)}. Total: $${(amount + fee).toFixed(2)}`; moneyOutFeeDisplay.style.display = 'block'; } else { moneyOutFeeDisplay.style.display = 'none'; } }); document.getElementById('money-out-form').addEventListener('submit', async (e) => { e.preventDefault(); const outBtn = document.getElementById('money-out-btn'); const agentId = document.getElementById('agent-id').value.trim(); const amount = parseFloat(moneyOutAmountInput.value); const messageBox = document.getElementById('money-out-message'); if (!agentId.startsWith("AWMT")) { showMessage(messageBox, 'error', 'Invalid Agent ID format.'); return; } toggleButtonLoading(outBtn, true); setTimeout(() => { showMessage(messageBox, 'success', `Request for $${amount.toFixed(2)} to Agent ${agentId} is processing.`); document.getElementById('money-out-form').reset(); toggleButtonLoading(outBtn, false); }, 2000); });
    document.getElementById('save-settings-btn').addEventListener('click', async () => { const newName = document.getElementById('settings-name').value; const newDob = document.getElementById('settings-dob').value; if (newName && newDob) { try { await db.collection('users').doc(currentUser.uid).update({ name: newName, dob: newDob }); alert('Settings saved!'); navigateTo('profile'); } catch (error) { alert('Error: ' + error.message); } } else { alert('Please fill all fields.'); } }); document.getElementById('change-password-btn').addEventListener('click', async () => { const currentPass = document.getElementById('current-password').value; const newPass = document.getElementById('new-password').value; if(newPass.length < 6) { alert("New password must be at least 6 characters."); return; } try { const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass); await auth.currentUser.reauthenticateWithCredential(credential); await auth.currentUser.updatePassword(newPass); alert("Password changed!"); document.getElementById('current-password').value = ''; document.getElementById('new-password').value = ''; } catch (error) { alert("Failed: " + error.message); } });
    const qrModal = document.getElementById('qr-modal'); const showQrBtn = document.getElementById('show-qr-btn'); const closeQrBtn = document.getElementById('modal-close-btn'); showQrBtn.addEventListener('click', () => { generateQRCode(currentUser.userId); document.getElementById('modal-user-id').textContent = currentUser.userId; qrModal.style.display = 'flex'; }); const closeModal = () => { qrModal.style.display = 'none'; }; closeQrBtn.addEventListener('click', closeModal); qrModal.addEventListener('click', (e) => { if(e.target === qrModal) { closeModal(); } });
    function showMessage(element, type, text) { element.className = `message-box ${type}`; element.innerHTML = `<div class="message-icon ${type}"><i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i></div><p>${text}</p>`; element.style.display = 'block'; setTimeout(() => { element.style.display = 'none'; }, 5000); }
    function copyText(elementId) { const input = document.getElementById(elementId); input.select(); document.execCommand('copy'); alert(`Copied User ID: ${input.value}`); }
    function generateQRCode(text) { const qrContainer = document.getElementById('modal-qrcode-container'); qrContainer.innerHTML = ''; const qr = qrcode(0, 'L'); qr.addData(text); qr.make(); qrContainer.innerHTML = qr.createImgTag(6, 10); }

    // ### নতুন যুক্ত করা হয়েছে: QR Code Scanner এর সম্পূর্ণ লজিক ###
    const qrScannerModal = document.getElementById('qr-scanner-modal');
    
    // QR স্ক্যানার শুরু করার ফাংশন
    function startQrScanner(inputId) {
        activeQrInputId = inputId;
        qrScannerModal.style.display = 'flex';
        
        // যদি স্ক্যানার আগে থেকে চালু না থাকে
        if (!html5QrCodeScanner) {
            html5QrCodeScanner = new Html5Qrcode("qr-reader");
        }
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        // ক্যামেরা শুরু করা
        html5QrCodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => {
            console.error("QR Scanner Error:", err);
            alert("Could not start QR scanner. Please grant camera permission.");
            stopQrScanner();
        });
    }

    // স্ক্যান সফল হলে এই ফাংশন কাজ করবে
    function onScanSuccess(decodedText, decodedResult) {
        if (activeQrInputId) {
            document.getElementById(activeQrInputId).value = decodedText;
        }
        stopQrScanner();
    }

    // স্ক্যানার বন্ধ করার ফাংশন
    function stopQrScanner() {
        if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
            html5QrCodeScanner.stop().then(() => {
                // console.log("QR Scanner stopped.");
            }).catch(err => {
                console.error("Failed to stop QR Scanner:", err);
            });
        }
        qrScannerModal.style.display = 'none';
        activeQrInputId = null;
    }

    // 'Send Money' পেজের QR বাটনে ইভেন্ট যোগ করা
    document.getElementById('scan-qr-send').addEventListener('click', () => {
        startQrScanner('recipient-id');
    });

    // 'Money Out' পেজের QR বাটনে ইভেন্ট যোগ করা
    document.getElementById('scan-qr-out').addEventListener('click', () => {
        startQrScanner('agent-id');
    });
    
    // স্ক্যানার মডালের ক্লোজ বাটনে ইভেন্ট যোগ করা
    document.getElementById('qr-scanner-close-btn').addEventListener('click', stopQrScanner);
    
    </script>
</body>
</html>