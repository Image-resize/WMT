<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Money Transfer (WMT)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.4/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1a73e8;
            --secondary: #34a853;
            --accent: #fbbc05;
            --danger: #ea4335;
            --light: #f8f9fa;
            --dark: #202124;
            --gray: #5f6368;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Auth Pages */
        .auth-container {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a73e8 0%, #34a853 100%);
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            padding: 30px;
            transition: transform 0.3s ease;
        }

        .auth-card:hover {
            transform: translateY(-5px);
        }

        .logo {
            text-align: center;
            margin-bottom: 25px;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo p {
            color: var(--gray);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: #1669d6;
            transform: translateY(-2px);
        }

        .btn.loading {
            color: transparent;
            cursor: not-allowed;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: btn-loader 1s ease infinite;
        }

        @keyframes btn-loader {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }


        .btn-secondary { background: var(--secondary); }
        .btn-secondary:hover { background: #2d9355; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #d33223; }

        .auth-links {
            text-align: center;
            margin-top: 20px;
        }

        .auth-links a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-links a:hover { text-decoration: underline; }

        .profile-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            margin: 0 auto 15px;
            display: block;
            background-color: #e8f0fe;
        }

        .upload-btn {
            background: var(--light);
            color: var(--dark);
            border: 1px dashed var(--gray);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #e8f0fe;
            border-color: var(--primary);
        }

        .home-container { display: none; }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
        }

        .menu-toggle {
            font-size: 24px;
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-toggle:hover { color: var(--primary); }
        .app-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-img-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 200;
            transition: all 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar.active { left: 0; }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            display: none;
        }

        .sidebar-overlay.active { display: block; }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .sidebar-close { font-size: 24px; color: var(--dark); cursor: pointer; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li { margin-bottom: 10px; }
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: #e8f0fe;
            color: var(--primary);
        }
        .sidebar-menu a.kyc-verified-link {
            color: var(--secondary);
            pointer-events: none; /* Make it unclickable */
        }
        .sidebar-menu i { font-size: 20px; width: 24px; text-align: center; }

        .main-content { padding: 20px 0; }
        .page { display: none; }
        .page.active { display: block; }

        .welcome-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 12px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
        }
        .welcome-section h2 { font-size: 24px; margin-bottom: 10px; }

        .balance-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 25px;
        }
        .balance-card h3 { color: var(--gray); font-size: 16px; margin-bottom: 10px; }
        .balance-amount { font-size: 32px; font-weight: 700; color: var(--dark); }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .service-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .service-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 20px;
            color: white;
        }
        .add-money .service-icon { background: var(--primary); }
        .send-money .service-icon { background: var(--secondary); }
        .money-out .service-icon { background: var(--accent); }
        .payment .service-icon { background: var(--danger); }
        .bill-pay .service-icon { background: #673ab7; }
        .service-card h4 { font-size: 14px; color: var(--dark); }

        .transactions-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .section-header h3 { font-size: 18px; color: var(--dark); }
        .view-all { color: var(--primary); text-decoration: none; font-weight: 500; font-size: 14px; }
        .transaction-list { list-style: none; }
        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-info { display: flex; align-items: center; gap: 15px; }
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        .transaction-details h4 { font-size: 16px; margin-bottom: 5px; }
        .transaction-details p { font-size: 14px; color: var(--gray); }
        .transaction-amount { font-weight: 600; }
        .credit { color: var(--secondary); }
        .debit { color: var(--danger); }
        
        /* New Styles for Transaction ID */
        .transaction-id-container {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .copy-icon {
            cursor: pointer;
            transition: color 0.2s;
        }
        .copy-icon:hover {
            color: var(--primary);
        }


        .form-page {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
        }
        .form-page h2 { margin-bottom: 20px; color: var(--dark); font-size: 22px; }

        .user-id-section {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .user-id-section h4 { color: var(--secondary); margin-bottom: 10px; }
        .user-id-display { display: flex; gap: 10px; margin-top: 10px; }
        .user-id-display input {
            flex: 1;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            background: #f9f9f9;
        }
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 15px;
            cursor: pointer;
        }

        .message-box {
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        .message-box.success { background: #e8f5e9; border: 1px solid #c8e6c9; }
        .message-box.error { background: #fdecea; border: 1px solid #f5c6cb; }
        .message-icon { font-size: 50px; margin-bottom: 15px; }
        .message-icon.success { color: var(--secondary); }
        .message-icon.error { color: var(--danger); }

        .fee-display {
            background-color: #f0f4f8;
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--gray);
            text-align: center;
        }

        .kyc-status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .kyc-verified {
            background-color: #e8f5e9;
            color: var(--secondary);
            border: 1px solid #a5d6a7;
        }

        .kyc-not-verified {
            background-color: #fdecea;
            color: var(--danger);
            border: 1px solid #f5c6cb;
        }

        /* QR Code Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 400px;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            color: var(--gray);
            cursor: pointer;
            font-weight: bold;
        }
        #modal-qrcode-container img {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        #qr-scanner-modal .modal-content {
            width: 500px;
            max-width: 95%;
        }
        #qr-reader {
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* NEW: Confirmation Popup Styles */
        .confirmation-details .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
        }
        .confirmation-details .info-row span {
            color: var(--gray);
        }
        
        .confirmation-details .info-row strong.mono-font {
             font-family: monospace;
             font-size: 14px;
        }


        @media (max-width: 768px) {
            .services-grid { grid-template-columns: repeat(3, 1fr); }
            .auth-card { padding: 20px; }
        }

        @media (max-width: 576px) {
            .services-grid { grid-template-columns: repeat(2, 1fr); }
            .balance-amount { font-size: 28px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="auth-container" id="login-page">
        <div class="auth-card">
            <div class="logo"><h1>WMT</h1><p>Web Money Transfer</p></div>
            <form id="login-form">
                <div class="form-group"><label for="login-email">Gmail</label><input type="email" class="form-control" id="login-email" placeholder="your.email@gmail.com" required></div>
                <div class="form-group"><label for="login-password">Password</label><input type="password" class="form-control" id="login-password" placeholder="Enter your password" required></div>
                <button type="submit" class="btn" id="login-btn">Login</button>
            </form>
            <div class="auth-links"><p>Don't have an account? <a href="#" id="go-to-signup">Sign Up</a></p></div>
        </div>
    </div>

    <!-- Signup Page -->
    <div class="auth-container" id="signup-page" style="display: none;">
        <div class="auth-card">
            <div class="logo"><h1>WMT</h1><p>Web Money Transfer</p></div>
            <form id="signup-form">
                <div class="profile-upload">
                    <img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-image" id="profile-preview">
                    <input type="file" id="image-upload" accept="image/*" style="display: none;">
                    <button type="button" class="upload-btn" id="upload-btn">Upload Profile Image</button>
                </div>
                <div class="form-group"><label for="name">Full Name</label><input type="text" class="form-control" id="name" placeholder="Enter your full name" required></div>
                <div class="form-group"><label for="dob">Date of Birth</label><input type="date" class="form-control" id="dob" required></div>
                <div class="form-group"><label for="email">Gmail</label><input type="email" class="form-control" id="email" placeholder="your.email@gmail.com" required></div>
                <div class="form-group"><label for="gender">Gender</label><select class="form-control" id="gender" required><option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
                <div class="form-group"><label for="password">Password (Minimum 6 characters)</label><input type="password" class="form-control" id="password" placeholder="Create a password" minlength="6" required></div>
                <button type="submit" class="btn btn-secondary" id="signup-btn">Sign Up</button>
            </form>
            <div class="auth-links"><p>Already have an account? <a href="#" id="go-to-login">Login</a></p></div>
        </div>
    </div>

    <!-- Home Page -->
    <div class="home-container" id="home-page">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></div>
                    <div class="app-name">WMT</div>
                    <div class="profile-header"><img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-img-small" id="header-profile-img"></div>
                </div>
            </div>
        </header>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header"><h3>Menu</h3><div class="sidebar-close" id="sidebar-close"><i class="fas fa-times"></i></div></div>
            <ul class="sidebar-menu">
                <li><a href="#" class="sidebar-link active" data-page="home"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" class="sidebar-link" data-page="wallet"><i class="fas fa-wallet"></i> Wallet</a></li>
                <li><a href="#" class="sidebar-link" data-page="transactions"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
                <li><a href="#" class="sidebar-link" data-page="kyc" id="sidebar-kyc-link"><i class="fas fa-user-check"></i> KYC Verify</a></li>
                <li><a href="#" class="sidebar-link" data-page="profile"><i class="fas fa-user"></i> Profile</a></li>
                <li><a href="#" class="sidebar-link" data-page="settings"><i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <main class="main-content">
            <div class="container">
                <div class="page active" id="home-content">
                    <div class="welcome-section"><h2>Hello, <span id="user-name">User</span>!</h2><p>Welcome to Web Money Transfer</p></div>
                    <div id="home-kyc-status"></div>
                    <!-- ===== হোম পেজ থেকে ব্যালেন্স কার্ডটি সরিয়ে দেওয়া হয়েছে ===== -->
                    <div class="services-grid">
                        <div class="service-card add-money" data-service="add-money"><div class="service-icon"><i class="fas fa-plus"></i></div><h4>Add Money</h4></div>
                        <div class="service-card send-money" data-service="send-money"><div class="service-icon"><i class="fas fa-paper-plane"></i></div><h4>Send Money</h4></div>
                        <div class="service-card money-out" data-service="money-out"><div class="service-icon"><i class="fas fa-money-bill-wave"></i></div><h4>Money Out</h4></div>
                        <div class="service-card payment" data-service="payment"><div class="service-icon"><i class="fas fa-credit-card"></i></div><h4>Payment</h4></div>
                        <div class="service-card bill-pay" data-service="bill-pay"><div class="service-icon"><i class="fas fa-file-invoice-dollar"></i></div><h4>Bill Pay</h4></div>
                    </div>
                    <div class="transactions-section">
                        <div class="section-header"><h3>Recent Transactions</h3><a href="#" class="view-all" id="view-all-transactions">View All</a></div>
                        <ul class="transaction-list" id="recent-transactions"></ul>
                    </div>
                </div>

                <div class="page" id="wallet-content">
                    <div class="form-page">
                        <h2>My Wallet</h2>
                        <div class="balance-card"><h3>Available Balance</h3><div class="balance-amount">$<span id="wallet-balance">0.00</span></div></div>
                        <div class="user-id-section">
                            <h4>Your Unique User ID</h4><p>Use this ID to receive money from other WMT users.</p>
                            <div class="user-id-display"><input type="text" id="wallet-user-id" value="WMT12345" readonly><button class="copy-btn" onclick="copyToClipboard(document.getElementById('wallet-user-id').value, 'User ID')">Copy</button></div>
                        </div>
                    </div>
                </div>

                <div class="page" id="transactions-content">
                    <div class="form-page"><h2>Transaction History</h2><div class="transactions-section"><ul class="transaction-list" id="all-transactions"></ul></div></div>
                </div>

                <div class="page" id="kyc-content">
                    <div class="form-page">
                        <h2>KYC Verification</h2>
                        <div id="kyc-status-page"></div>
                        <div id="kyc-form-section">
                            <p>Please enter the verification code provided by the admin to verify your account.</p>
                            <div class="form-group" style="margin-top: 20px;"><label for="kyc-code">Verification Code</label><input type="text" class="form-control" id="kyc-code" placeholder="Enter verification code from admin"></div>
                            <button class="btn" id="kyc-submit-btn">Submit Code</button>
                            <div id="kyc-message" class="message-box"></div>
                        </div>
                    </div>
                </div>

                <div class="page" id="profile-content">
                    <div class="form-page">
                        <h2>My Profile</h2>
                        <div class="profile-upload"><img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-image" id="profile-image-view"></div>
                        <button class="btn btn-secondary" id="show-qr-btn" style="margin-bottom: 20px;"><i class="fas fa-qrcode"></i> Show MY QR Code</button>
                        <div class="form-group"><label>Full Name</label><div class="form-control" style="background: #f9f9f9;" id="profile-name"></div></div>
                        <div class="form-group">
                            <label>User ID</label>
                            <div class="user-id-display"><input type="text" class="form-control" id="profile-user-id" value="WMT12345" readonly><button class="copy-btn" onclick="copyToClipboard(document.getElementById('profile-user-id').value, 'User ID')">Copy</button></div>
                        </div>
                        <div class="form-group"><label>Email</label><div class="form-control" style="background: #f9f9f9;" id="profile-email"></div></div>
                        <div class="form-group"><label>Date of Birth</label><div class="form-control" style="background: #f9f9f9;" id="profile-dob"></div></div>
                    </div>
                </div>

                <div class="page" id="settings-content">
                    <div class="form-page">
                        <h2>Settings</h2>
                        <div class="profile-upload">
                            <img src="https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png" alt="Profile" class="profile-image" id="settings-profile-preview">
                            <input type="file" id="settings-image-upload" accept="image/*" style="display: none;">
                            <button type="button" class="upload-btn" id="settings-upload-btn">Change Profile Image</button>
                        </div>
                        <div class="form-group"><label for="settings-name">Full Name</label><input type="text" class="form-control" id="settings-name"></div>
                        <div class="form-group"><label for="settings-dob">Date of Birth</label><input type="date" class="form-control" id="settings-dob"></div>
                        <button class="btn" id="save-settings-btn">Save Basic Info</button>
                        <hr style="margin: 25px 0; border: 1px solid #f0f0f0;">
                        <h3>Change Password</h3>
                        <div class="form-group"><label for="current-password">Current Password</label><input type="password" class="form-control" id="current-password" placeholder="Enter your current password"></div>
                        <div class="form-group"><label for="new-password">New Password</label><input type="password" class="form-control" id="new-password" placeholder="Enter new password (min. 6 characters)"></div>
                        <button class="btn btn-secondary" id="change-password-btn">Change Password</button>
                    </div>
                </div>

                <div class="page" id="add-money-content">
                    <div class="form-page">
                        <h2>Add Money</h2>
                        <div class="form-group"><label for="redeem-code">Redeem Code</label><input type="text" class="form-control" id="redeem-code" placeholder="Enter redeem code from admin"></div>
                        <div class="form-group"><label for="redeem-password">Code Password</label><input type="password" class="form-control" id="redeem-password" placeholder="Enter password for the code"></div>
                        <button class="btn" id="redeem-btn">Redeem Code</button>
                        <div id="redeem-message" class="message-box"></div>
                    </div>
                </div>

                <div class="page" id="send-money-content">
                    <div class="form-page">
                        <h2>Send Money</h2>
                        <form id="send-money-form">
                            <div class="form-group">
                                <label for="recipient-id">Recipient User ID (WMT ID)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" id="recipient-id" placeholder="Enter recipient's WMT ID" required>
                                    <button type="button" class="btn" id="scan-qr-send" style="width: auto;"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </div>
                            <div class="form-group"><label for="send-amount">Amount ($)</label><input type="number" step="0.01" class="form-control" id="send-amount" placeholder="Min $0.01, Max $100" required></div>
                            <div class="fee-display" id="send-fee-display" style="display: none;"></div>
                            <div class="form-group" style="margin-top: 20px;"><label for="send-password">Your Password</label><input type="password" class="form-control" id="send-password" placeholder="Enter your password to confirm" required></div>
                            <button type="submit" class="btn" id="send-money-btn">Send Money</button>
                        </form>
                        <div id="send-money-message" class="message-box"></div>
                    </div>
                </div>

                <div class="page" id="money-out-content">
                    <div class="form-page">
                        <h2>Money Out</h2>
                        <form id="money-out-form">
                           <div class="form-group">
                                <label for="agent-id">Agent User ID (AWMT ID)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" id="agent-id" placeholder="Enter Agent's AWMT ID" required>
                                    <button type="button" class="btn" id="scan-qr-out" style="width: auto;"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </div>
                            <div class="form-group"><label for="money-out-amount">Amount ($)</label><input type="number" step="0.01" class="form-control" id="money-out-amount" placeholder="Enter amount to cash out" required></div>
                            <div class="fee-display" id="money-out-fee-display" style="display: none;"></div>
                            <div class="form-group" style="margin-top: 20px;"><label for="money-out-password">Your Password</label><input type="password" class="form-control" id="money-out-password" placeholder="Enter your password to confirm" required></div>
                            <button type="submit" class="btn" id="money-out-btn">Money Out</button>
                        </form>
                         <div id="money-out-message" class="message-box"></div>
                    </div>
                </div>
                
                <!-- NEW PAYMENT PAGE -->
                <div class="page" id="payment-content">
                    <div class="form-page">
                        <h2>Payment</h2>
                        <form id="payment-form">
                           <div class="form-group">
                                <label for="payment-id">Merchant ID (PWMT ID)</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" id="payment-id" placeholder="Enter Merchant's PWMT ID" required>
                                    <button type="button" class="btn" id="scan-qr-payment" style="width: auto;"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </div>
                            <div class="form-group"><label for="payment-amount">Amount ($)</label><input type="number" step="0.01" class="form-control" id="payment-amount" placeholder="Enter payment amount" required></div>
                            <div class="fee-display">Fee: $0.00 (No fee for payments)</div>
                            <div class="form-group" style="margin-top: 20px;"><label for="payment-password">Your Password</label><input type="password" class="form-control" id="payment-password" placeholder="Enter your password to confirm" required></div>
                            <button type="submit" class="btn" id="payment-btn">Make Payment</button>
                        </form>
                         <div id="payment-message" class="message-box"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- QR Code Modal -->
    <div class="modal-overlay" id="qr-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close-btn">&times;</span>
            <h3>Scan to Pay Me</h3>
            <div id="modal-qrcode-container"></div>
            <p style="margin-top: 10px; color: var(--gray);">Your User ID: <strong id="modal-user-id"></strong></p>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal-overlay" id="qr-scanner-modal">
        <div class="modal-content">
            <span class="modal-close" id="qr-scanner-close-btn">&times;</span>
            <h3>Scan QR Code</h3>
            <div id="qr-reader" style="width: 100%;"></div>
        </div>
    </div>

    <!-- UPDATED: Transaction Confirmation Modal -->
    <div class="modal-overlay" id="confirmation-modal" style="display: none; align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 450px; text-align: left;">
            <div style="text-align: center; color: var(--secondary); margin-bottom: 20px;">
                <i class="fas fa-check-circle" style="font-size: 60px;"></i>
                <h3 style="margin-top: 15px; font-size: 22px;">Transaction Successful</h3>
            </div>
            
            <div class="confirmation-details">
                <div class="info-row">
                    <span>Amount:</span>
                    <strong id="confirm-amount"></strong>
                </div>
                <div class="info-row">
                    <span>Service Fee:</span>
                    <strong id="confirm-fee"></strong>
                </div>
                <div class="info-row">
                    <span>Total Deducted:</span>
                    <strong id="confirm-total"></strong>
                </div>
                <hr style="margin: 12px 0; border-top: 1px solid #eee;">
                <div class="info-row">
                    <span>Remaining Balance:</span>
                    <strong id="confirm-balance"></strong>
                </div>
                 <div class="info-row">
                    <span>Date & Time:</span>
                    <strong id="confirm-datetime"></strong>
                </div>
                <!-- NEW DYNAMIC ID ROW -->
                <div class="info-row" id="confirm-id-row" style="display: none;">
                    <span id="confirm-id-label"></span>
                    <strong id="confirm-id-value" class="mono-font"></strong>
                </div>
                <div class="info-row" style="align-items: center;">
                    <span>Transaction ID:</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <strong id="confirm-tx-id" class="mono-font" style="font-size: 12px;"></strong>
                        <i class="fas fa-copy" id="confirm-copy-btn" style="cursor: pointer; color: var(--primary);"></i>
                    </div>
                </div>
            </div>
            <button class="btn" id="confirmation-close-btn" style="margin-top: 25px;">Done</button>
        </div>
    </div>


    <script>
    // --- START OF SCRIPT ---
    
    const firebaseConfig = {
      apiKey: "AIzaSyAzU36v8dZ1jEMh1qxEAnNxDRAmoRCVbwY",
      authDomain: "wmt-services.firebaseapp.com",
      databaseURL: "https://wmt-services-default-rtdb.firebaseio.com",
      projectId: "wmt-services",
      storageBucket: "wmt-services.firebasestorage.app",
      messagingSenderId: "935651931226",
      appId: "1:935651931226:web:5c412bd299f215c14f5463",
      measurementId: "G-6NTS4GW1DK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null; 
    let signupProfileUrl = 'https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png'; 
    let servicesAreEnabled = true; // Global variable for service status
    
    // Default fees, will be updated from Firestore
    let configFees = {
        sendMoneyFixedFee: 0.05,
        moneyOutPercentageFee: 0.01
    };

    const allPages = ['login-page', 'signup-page', 'home-page'];
    const pages = document.querySelectorAll('.page');
    let html5QrCodeScanner = null;
    let activeQrInputId = null;
    
    function showMainContainer(pageId) {
        allPages.forEach(p => {
            const el = document.getElementById(p);
            if (p === pageId) {
                el.style.display = (p === 'home-page') ? 'block' : 'flex';
            } else {
                el.style.display = 'none';
            }
        });
    }

    function toggleButtonLoading(btn, isLoading) {
        if (isLoading) {
            btn.classList.add('loading');
            btn.disabled = true;
        } else {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }
    
    // --- Event Listeners for Page Navigation ---
    document.getElementById('go-to-signup').addEventListener('click', (e) => { e.preventDefault(); showMainContainer('signup-page'); });
    document.getElementById('go-to-login').addEventListener('click', (e) => { e.preventDefault(); showMainContainer('login-page'); });
    document.getElementById('menu-toggle').addEventListener('click', () => { 
        document.getElementById('sidebar').classList.add('active'); 
        document.getElementById('sidebar-overlay').classList.add('active'); 
    });
    const closeSidebar = () => {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebar-overlay').classList.remove('active');
    };
    document.getElementById('sidebar-close').addEventListener('click', closeSidebar);
    document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const page = link.getAttribute('data-page');
            if (page) {
                navigateTo(page);
                closeSidebar();
            }
        });
    });
    
    // MODIFIED: Service card click listener with service status check
    document.querySelectorAll('.service-card').forEach(card => {
        card.addEventListener('click', () => {
            if (!servicesAreEnabled) {
                alert("All services are temporarily disabled by the admin. Please try again later.");
                return;
            }
            if (currentUser && !currentUser.isKycVerified) {
                alert("Please complete KYC verification to use any services.");
                navigateTo('kyc');
                return;
            }
            const service = card.getAttribute('data-service');
            // UPDATED pageMap to include payment
            const pageMap = { 
                'add-money': 'add-money', 
                'send-money': 'send-money', 
                'money-out': 'money-out',
                'payment': 'payment' // Added payment page
            };
            if (pageMap[service]) {
                navigateTo(pageMap[service]);
            } else {
                alert(`${service} feature is under development!`);
            }
        });
    });

    document.getElementById('view-all-transactions').addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('transactions');
    });
    
    // --- Navigation and History Management ---
    function navigateTo(pageId) {
        showPage(pageId);
        if (window.location.hash !== `#${pageId}`) {
            history.pushState({ page: pageId }, '', `#${pageId}`);
        }
    }

    function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(`${pageId}-content`);
        if (targetPage) targetPage.classList.add('active');
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`.sidebar-link[data-page="${pageId}"]`);
        if(activeLink) activeLink.classList.add('active');
    }

    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.page) {
            showPage(event.state.page);
        } else {
            const hashPage = window.location.hash.substring(1);
            showPage(hashPage || 'home');
        }
    });

    // --- Authentication ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    currentUser = { uid: user.uid, ...doc.data() };
                    if (!document.getElementById('home-page').style.display || document.getElementById('home-page').style.display === 'none') {
                        initializeAppUI();
                    } else {
                        updateAllUI();
                    }
                } else {
                    console.error("User data not found in Firestore!");
                    auth.signOut();
                }
            }, error => {
                console.error("Error fetching user data:", error);
                auth.signOut();
            });
        } else {
            currentUser = null;
            showMainContainer('login-page');
            history.replaceState(null, '', window.location.pathname);
            document.getElementById('login-form').reset();
        }
    });

    document.getElementById('signup-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const signupBtn = document.getElementById('signup-btn');
        toggleButtonLoading(signupBtn, true);
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value.toLowerCase();
        const password = document.getElementById('password').value;
        const dob = document.getElementById('dob').value;
        const gender = document.getElementById('gender').value;
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                const newUserId = `WMT${Date.now() % 100000 + Math.floor(Math.random() * 1000)}`;
                db.collection('users').doc(user.uid).set({
                    userId: newUserId, name, email, dob, gender,
                    balance: 0.00, profileImg: signupProfileUrl, isKycVerified: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => alert("Signup successful!"))
                  .catch((error) => alert("Error saving user data: " + error.message))
                  .finally(() => toggleButtonLoading(signupBtn, false));
            })
            .catch((error) => {
                alert("Signup failed: " + error.message);
                toggleButtonLoading(signupBtn, false);
            });
    });

    document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const loginBtn = document.getElementById('login-btn');
        toggleButtonLoading(loginBtn, true);
        const email = document.getElementById('login-email').value.toLowerCase();
        const password = document.getElementById('login-password').value;
        auth.signInWithEmailAndPassword(email, password)
            .catch((error) => alert('Invalid email or password. Error: ' + error.message))
            .finally(() => toggleButtonLoading(loginBtn, false));
    });
    
    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        auth.signOut().then(closeSidebar);
    });

    // --- Listen for Fee Configuration from Admin ---
    function listenForFeeUpdates() {
        db.collection('settings').doc('fees').onSnapshot((doc) => {
            if (doc.exists) {
                console.log("Fee configuration updated from Firestore.");
                const feeData = doc.data();
                configFees.sendMoneyFixedFee = feeData.sendMoneyFixedFee || 0.05;
                configFees.moneyOutPercentageFee = feeData.moneyOutPercentageFee || 0.01;
            } else {
                console.log("No fee configuration found in Firestore, using default values.");
            }
        }, (error) => {
            console.error("Error fetching fee configuration:", error);
        });
    }
    
    // --- NEW: Listen for Service Status from Admin ---
    function listenForServiceStatus() {
        db.collection('settings').doc('status').onSnapshot((doc) => {
            if (doc.exists && doc.data().servicesEnabled === false) {
                servicesAreEnabled = false;
                console.log("Services are currently DISABLED by admin.");
            } else {
                servicesAreEnabled = true;
                console.log("Services are ENABLED.");
            }
        }, (error) => {
            console.error("Error fetching service status:", error);
            // In case of error, assume services are enabled to not block users unnecessarily
            servicesAreEnabled = true;
        });
    }
    
    function initializeAppUI() {
        if (!currentUser) return;
        showMainContainer('home-page');
        listenForFeeUpdates();
        listenForServiceStatus(); // Start listening for service status
        const initialPage = window.location.hash ? window.location.hash.substring(1) : 'home';
        showPage(initialPage);
        history.replaceState({ page: initialPage }, '', `#${initialPage}`);
        updateAllUI();
    }

    function updateAllUI() {
        if (!currentUser) return;
        const formattedBalance = (currentUser.balance || 0).toFixed(2);
        
        // ===== জাভাস্ক্রিপ্ট থেকেও হোম পেজের ব্যালেন্স আপডেট করার লাইনটি সরিয়ে দেওয়া হয়েছে =====
        
        document.getElementById('wallet-balance').textContent = formattedBalance;
        document.getElementById('user-name').textContent = currentUser.name.split(' ')[0];
        document.getElementById('header-profile-img').src = currentUser.profileImg;
        document.getElementById('profile-name').textContent = currentUser.name;
        document.getElementById('profile-email').textContent = currentUser.email;
        document.getElementById('profile-dob').textContent = currentUser.dob;
        document.getElementById('profile-image-view').src = currentUser.profileImg;
        document.getElementById('profile-user-id').value = currentUser.userId;
        document.getElementById('wallet-user-id').value = currentUser.userId;
        document.getElementById('settings-name').value = currentUser.name;
        document.getElementById('settings-dob').value = currentUser.dob;
        document.getElementById('settings-profile-preview').src = currentUser.profileImg;
        updateKycStatusUI();
        loadTransactions();
    }
    
    function updateKycStatusUI() {
        const homeKycStatus = document.getElementById('home-kyc-status');
        const pageKycStatus = document.getElementById('kyc-status-page');
        const kycForm = document.getElementById('kyc-form-section');
        const sidebarKycLink = document.getElementById('sidebar-kyc-link');
        
        homeKycStatus.innerHTML = '';
        pageKycStatus.innerHTML = '';

        if (currentUser.isKycVerified) {
            const verifiedHTML = `<div class="kyc-status kyc-verified"><i class="fas fa-check-circle"></i> KYC Verified</div>`;
            pageKycStatus.innerHTML = verifiedHTML;
            kycForm.style.display = 'none';
            homeKycStatus.style.display = 'none';
            sidebarKycLink.innerHTML = `<i class="fas fa-check-circle"></i> KYC Verified`;
            sidebarKycLink.classList.add('kyc-verified-link');
            
        } else {
            const notVerifiedHTML = `<div class="kyc-status kyc-not-verified"><i class="fas fa-exclamation-triangle"></i> KYC Not Verified. Please verify to transact.</div>`;
            homeKycStatus.innerHTML = notVerifiedHTML;
            pageKycStatus.innerHTML = notVerifiedHTML;
            homeKycStatus.style.display = 'block';
            kycForm.style.display = 'block';
            sidebarKycLink.innerHTML = `<i class="fas fa-user-check"></i> KYC Verify`;
            sidebarKycLink.classList.remove('kyc-verified-link');
        }
    }
    
    // Return the transaction ID
    async function addTransaction(uid, type, amount, description, icon) { 
        if (!uid) return null; 
        const transaction = { type, amount, description, icon, date: firebase.firestore.Timestamp.now() }; 
        try {
            const docRef = await db.collection('users').doc(uid).collection('transactions').add(transaction);
            await docRef.update({ transactionId: docRef.id });
            return docRef.id; // Return the new transaction ID
        } catch (error) {
            console.error("Error creating transaction:", error);
            return null;
        }
    }

    function loadTransactions() { 
        if (!currentUser) return; 
        db.collection('users').doc(currentUser.uid).collection('transactions').orderBy('date', 'desc').limit(20).onSnapshot(querySnapshot => { 
            document.getElementById('recent-transactions').innerHTML = ''; 
            document.getElementById('all-transactions').innerHTML = ''; 
            let index = 0; 
            if (querySnapshot.empty) {
                const noTxMsg = "<li><p style='text-align:center; color: var(--gray);'>No transactions yet.</p></li>";
                document.getElementById('recent-transactions').innerHTML = noTxMsg;
                document.getElementById('all-transactions').innerHTML = noTxMsg;
                return;
            }
            querySnapshot.forEach(doc => { 
                const tx = doc.data(); 
                tx.transactionId = tx.transactionId || doc.id; 
                const readableDate = tx.date.toDate().toLocaleString(); 
                const txElement = createTransactionElement(tx, readableDate); 
                document.getElementById('all-transactions').appendChild(txElement.cloneNode(true)); 
                if (index < 5) { 
                    document.getElementById('recent-transactions').appendChild(txElement); 
                } 
                index++; 
            }); 
        }, error => console.error("Error loading transactions: ", error)); 
    }

    function createTransactionElement(tx, date) { 
        const li = document.createElement('li'); 
        li.className = 'transaction-item'; 
        const isCredit = tx.type === 'credit'; 
        const color = isCredit ? 'var(--secondary)' : 'var(--danger)'; 
        const sign = isCredit ? '+' : '-'; 
        const shortTxId = tx.transactionId.substring(0, 8) + '...';
        
        li.innerHTML = `
            <div class="transaction-info">
                <div class="transaction-icon" style="background-color: ${color};">
                    <i class="fas ${tx.icon}"></i>
                </div>
                <div class="transaction-details">
                    <h4>${tx.description}</h4>
                    <p>${date}</p>
                    <div class="transaction-id-container">
                        <span>ID: ${shortTxId}</span>
                        <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${tx.transactionId}', 'Transaction ID')"></i>
                    </div>
                </div>
            </div>
            <div class="transaction-amount ${tx.type}">
                ${sign}$${tx.amount.toFixed(2)}
            </div>`; 
        return li; 
    }
    
    document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('image-upload').click()); 
    document.getElementById('settings-upload-btn').addEventListener('click', () => document.getElementById('settings-image-upload').click());
    
    document.getElementById('image-upload').addEventListener('change', (e) => { 
        const file = e.target.files[0]; 
        if(file) handleImageUpload(file, document.getElementById('profile-preview'), (url) => { signupProfileUrl = url; }); 
    });
    
    document.getElementById('settings-image-upload').addEventListener('change', (e) => { 
        const file = e.target.files[0]; 
        if(file) handleImageUpload(file, document.getElementById('settings-profile-preview'), async (url) => { 
            await db.collection('users').doc(currentUser.uid).update({ profileImg: url }); 
            alert("Profile image updated successfully!"); 
        }); 
    });
    
    async function handleImageUpload(file, previewElement, callback) { 
        const cloudName = 'dntvrm1wn'; 
        const uploadPreset = 'ml_default'; 
        const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`; 
        const formData = new FormData(); 
        formData.append('file', file); 
        formData.append('upload_preset', uploadPreset); 
        previewElement.src = "https://i.gifer.com/ZZ5H.gif"; 
        try { 
            const response = await fetch(url, { method: 'POST', body: formData }); 
            const data = await response.json(); 
            if (data.secure_url) { 
                previewElement.src = data.secure_url; 
                callback(data.secure_url); 
            } else { 
                throw new Error('Image upload failed'); 
            } 
        } catch (error) { 
            alert('Error uploading image. Please try again.'); 
            previewElement.src = 'https://res.cloudinary.com/dntvrm1wn/image/upload/v1625151899/avatar_ml_default.png'; 
        } 
    }

    document.getElementById('kyc-submit-btn').addEventListener('click', async () => {
        const kycBtn = document.getElementById('kyc-submit-btn');
        const codeInput = document.getElementById('kyc-code').value.trim().toUpperCase();
        const messageBox = document.getElementById('kyc-message');
        if (!codeInput) { showMessage(messageBox, 'error', 'Please enter a verification code.'); return; }
        toggleButtonLoading(kycBtn, true);
        try {
            const kycCodesRef = db.collection('kyc_codes');
            const querySnapshot = await kycCodesRef.where('code', '==', codeInput).limit(1).get();
            if (querySnapshot.empty) {
                throw new Error('Invalid KYC code. Please check the code and try again.');
            }
            const kycDoc = querySnapshot.docs[0];
            const kycData = kycDoc.data();
            if (kycData.isUsed) {
                throw new Error('This KYC code has already been used.');
            }
            const userRef = db.collection('users').doc(currentUser.uid);
            const kycDocRef = kycDoc.ref;
            await db.runTransaction(async (transaction) => {
                transaction.update(userRef, { isKycVerified: true });
                transaction.update(kycDocRef, { 
                    isUsed: true, 
                    usedBy: currentUser.uid,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            showMessage(messageBox, 'success', 'Congratulations! Your KYC verification is successful.');
        } catch (error) {
            console.error("KYC Verification Error: ", error);
            showMessage(messageBox, 'error', error.message || 'An error occurred during verification.');
        } finally {
            toggleButtonLoading(kycBtn, false);
        }
    });

    // UPDATED: Redeem button to show confirmation popup
    document.getElementById('redeem-btn').addEventListener('click', async () => {
        const redeemBtn = document.getElementById('redeem-btn');
        const code = document.getElementById('redeem-code').value.trim().toUpperCase();
        const password = document.getElementById('redeem-password').value;
        const messageBox = document.getElementById('redeem-message');

        if (!code || !password) {
            showMessage(messageBox, 'error', 'Please enter both code and password.');
            return;
        }

        toggleButtonLoading(redeemBtn, true);

        try {
            const codesRef = db.collection('redeem_codes');
            const querySnapshot = await codesRef.where('code', '==', code).limit(1).get();

            if (querySnapshot.empty) {
                throw new Error('Invalid code or password.');
            }

            const redeemDoc = querySnapshot.docs[0];
            const redeemData = redeemDoc.data();

            if (redeemData.password !== password) {
                throw new Error('Invalid code or password.');
            }
            if (redeemData.isUsed) {
                throw new Error('This code has already been used.');
            }
            if (redeemData.expiryDate && redeemData.expiryDate.toDate() < new Date()) {
                throw new Error('This code has expired.');
            }

            const userRef = db.collection('users').doc(currentUser.uid);
            const redeemCodeRef = redeemDoc.ref;
            
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists) throw new Error("User document does not exist!");
                
                const newBalance = (userDoc.data().balance || 0) + redeemData.amount;
                transaction.update(userRef, { balance: newBalance });
                transaction.update(redeemCodeRef, { 
                    isUsed: true,
                    usedBy: currentUser.uid,
                    usedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            const txId = await addTransaction(currentUser.uid, 'credit', redeemData.amount, `Redeemed Code`, 'fa-plus-circle');
            
            showConfirmationPopup({
                amount: redeemData.amount,
                fee: 0,
                finalBalance: currentUser.balance,
                txId: txId,
                idLabel: "Redeem Code",
                idValue: code
            });
            
            document.getElementById('redeem-code').value = '';
            document.getElementById('redeem-password').value = '';

        } catch (error) {
            console.error("Redeem Error: ", error);
            showMessage(messageBox, 'error', error.message);
        } finally {
            toggleButtonLoading(redeemBtn, false);
        }
    });
    
    const sendAmountInput = document.getElementById('send-amount'); 
    const sendFeeDisplay = document.getElementById('send-fee-display'); 
    
    sendAmountInput.addEventListener('input', () => { 
        const amount = parseFloat(sendAmountInput.value); 
        const fee = configFees.sendMoneyFixedFee;
        if (amount > 0) { 
            sendFeeDisplay.textContent = `Fee: $${fee.toFixed(2)}. Total: $${(amount + fee).toFixed(2)}`; 
            sendFeeDisplay.style.display = 'block'; 
        } else { 
            sendFeeDisplay.style.display = 'none'; 
        } 
    });
    
    // UPDATED: Send money form submission to show confirmation popup with WMT ID
    document.getElementById('send-money-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const sendBtn = document.getElementById('send-money-btn');
        const recipientId = document.getElementById('recipient-id').value.trim();
        const amount = parseFloat(sendAmountInput.value);
        const password = document.getElementById('send-password').value;
        const messageBox = document.getElementById('send-money-message');
        const fee = configFees.sendMoneyFixedFee;

        if (!servicesAreEnabled) {
            showMessage(messageBox, 'error', "Services are temporarily disabled by the admin.");
            return;
        }

        if (!recipientId || !amount || !password) {
             showMessage(messageBox, 'error', 'Please fill all fields.');
             return;
        }
        if (amount < 0.01 || amount > 100) {
            showMessage(messageBox, 'error', 'Amount must be between $0.01 and $100.');
            return;
        }

        toggleButtonLoading(sendBtn, true);

        try {
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            await auth.currentUser.reauthenticateWithCredential(credential);

            const totalDeduction = amount + fee;
            if (recipientId === currentUser.userId) {
                throw new Error("You cannot send money to yourself.");
            }
            if (totalDeduction > (currentUser.balance || 0)) {
                throw new Error("Insufficient balance.");
            }

            const usersRef = db.collection('users');
            const recipientQuery = usersRef.where('userId', '==', recipientId).limit(1);
            const recipientSnapshot = await recipientQuery.get();

            if (recipientSnapshot.empty) {
                throw new Error("Recipient not found.");
            }
            const recipientDoc = recipientSnapshot.docs[0];
            const recipient = { uid: recipientDoc.id, ...recipientDoc.data() };

            await db.runTransaction(async (transaction) => {
                const senderDocRef = usersRef.doc(currentUser.uid);
                const recipientDocRef = usersRef.doc(recipient.uid);
                
                transaction.update(senderDocRef, { balance: firebase.firestore.FieldValue.increment(-totalDeduction) });
                transaction.update(recipientDocRef, { balance: firebase.firestore.FieldValue.increment(amount) });
            });

            const txId = await addTransaction(currentUser.uid, 'debit', amount, `Sent to ${recipient.name}`, 'fa-paper-plane');
            await addTransaction(recipient.uid, 'credit', amount, `Received from ${currentUser.name}`, 'fa-wallet');
            await addTransaction(currentUser.uid, 'debit', fee, 'Send Money Fee', 'fa-file-invoice-dollar');
            
            showConfirmationPopup({
                amount: amount,
                fee: fee,
                finalBalance: currentUser.balance,
                txId: txId,
                idLabel: "WMT ID",
                idValue: recipient.userId
            });
            
            e.target.reset();
            sendFeeDisplay.style.display = 'none';

        } catch (error) {
            showMessage(messageBox, 'error', `Transaction failed: ${error.message}`);
        } finally {
            toggleButtonLoading(sendBtn, false);
            document.getElementById('send-password').value = '';
        }
    });

    const moneyOutAmountInput = document.getElementById('money-out-amount'); 
    const moneyOutFeeDisplay = document.getElementById('money-out-fee-display'); 
    
    moneyOutAmountInput.addEventListener('input', () => { 
        const amount = parseFloat(moneyOutAmountInput.value); 
        const feePercent = configFees.moneyOutPercentageFee;
        if (amount > 0) { 
            const fee = amount * feePercent; 
            moneyOutFeeDisplay.textContent = `Fee (${(feePercent * 100).toFixed(1)}%): $${fee.toFixed(2)}. Total: $${(amount + fee).toFixed(2)}`; 
            moneyOutFeeDisplay.style.display = 'block'; 
        } else { 
            moneyOutFeeDisplay.style.display = 'none'; 
        } 
    }); 
    
    // UPDATED: Money Out form with full functionality and confirmation popup
    document.getElementById('money-out-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const outBtn = document.getElementById('money-out-btn'); 
        const agentId = document.getElementById('agent-id').value.trim(); 
        const amount = parseFloat(moneyOutAmountInput.value); 
        const password = document.getElementById('money-out-password').value;
        const messageBox = document.getElementById('money-out-message'); 
        const feePercent = configFees.moneyOutPercentageFee;
        const fee = amount * feePercent;
        const totalDeduction = amount + fee;

        if (!agentId.startsWith("AWMT")) { 
            showMessage(messageBox, 'error', 'Invalid Agent ID format. It must start with AWMT.'); 
            return; 
        } 
        if (!amount || !password) {
             showMessage(messageBox, 'error', 'Please fill all fields.');
             return;
        }

        toggleButtonLoading(outBtn, true); 
        
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            await auth.currentUser.reauthenticateWithCredential(credential);
            
            if (totalDeduction > (currentUser.balance || 0)) {
                throw new Error("Insufficient balance for money out and fees.");
            }

            const usersRef = db.collection('users');
            const agentQuery = usersRef.where('userId', '==', agentId).limit(1);
            const agentSnapshot = await agentQuery.get();

            if (agentSnapshot.empty) {
                throw new Error("Agent not found.");
            }
            const agentDoc = agentSnapshot.docs[0];
            const agent = { uid: agentDoc.id, ...agentDoc.data() };

            await db.runTransaction(async (transaction) => {
                const userDocRef = usersRef.doc(currentUser.uid);
                const agentDocRef = usersRef.doc(agent.uid);
                
                transaction.update(userDocRef, { balance: firebase.firestore.FieldValue.increment(-totalDeduction) });
                transaction.update(agentDocRef, { balance: firebase.firestore.FieldValue.increment(amount) });
            });
            
            const txId = await addTransaction(currentUser.uid, 'debit', amount, `Money Out to Agent ${agent.name}`, 'fa-money-bill-wave');
            await addTransaction(currentUser.uid, 'debit', fee, 'Money Out Fee', 'fa-file-invoice-dollar');

            showConfirmationPopup({
                amount: amount,
                fee: fee,
                finalBalance: currentUser.balance,
                txId: txId,
                idLabel: "Agent ID", // Using AWMT as per user request
                idValue: agent.userId
            });

            e.target.reset();
            moneyOutFeeDisplay.style.display = 'none';

        } catch(error) {
            showMessage(messageBox, 'error', `Money Out failed: ${error.message}`);
        } finally {
            toggleButtonLoading(outBtn, false); 
            document.getElementById('money-out-password').value = '';
        }
    });
    
    // NEW: Payment form functionality
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const paymentBtn = document.getElementById('payment-btn');
        const paymentId = document.getElementById('payment-id').value.trim();
        const amount = parseFloat(document.getElementById('payment-amount').value);
        const password = document.getElementById('payment-password').value;
        const messageBox = document.getElementById('payment-message');
        const fee = 0; // No fee for payments

        if (!paymentId.startsWith("PWMT")) { 
            showMessage(messageBox, 'error', 'Invalid Merchant ID format. It must start with PWMT.'); 
            return; 
        }
        if (!amount || !password) {
             showMessage(messageBox, 'error', 'Please fill all fields.');
             return;
        }
        toggleButtonLoading(paymentBtn, true);
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            await auth.currentUser.reauthenticateWithCredential(credential);

            if (amount > (currentUser.balance || 0)) {
                throw new Error("Insufficient balance.");
            }

            const usersRef = db.collection('users');
            const merchantQuery = usersRef.where('userId', '==', paymentId).limit(1);
            const merchantSnapshot = await merchantQuery.get();

            if (merchantSnapshot.empty) {
                throw new Error("Merchant not found.");
            }
            const merchantDoc = merchantSnapshot.docs[0];
            const merchant = { uid: merchantDoc.id, ...merchantDoc.data() };

            await db.runTransaction(async (transaction) => {
                const userDocRef = usersRef.doc(currentUser.uid);
                const merchantDocRef = usersRef.doc(merchant.uid);
                
                transaction.update(userDocRef, { balance: firebase.firestore.FieldValue.increment(-amount) });
                transaction.update(merchantDocRef, { balance: firebase.firestore.FieldValue.increment(amount) });
            });

            const txId = await addTransaction(currentUser.uid, 'debit', amount, `Payment to ${merchant.name}`, 'fa-credit-card');
            await addTransaction(merchant.uid, 'credit', amount, `Payment from ${currentUser.name}`, 'fa-credit-card');
            
            showConfirmationPopup({
                amount: amount,
                fee: fee,
                finalBalance: currentUser.balance,
                txId: txId,
                idLabel: "PWMT ID",
                idValue: merchant.userId
            });
            
            e.target.reset();
        } catch (error) {
            showMessage(messageBox, 'error', `Payment failed: ${error.message}`);
        } finally {
            toggleButtonLoading(paymentBtn, false);
            document.getElementById('payment-password').value = '';
        }
    });

    document.getElementById('save-settings-btn').addEventListener('click', async () => { 
        const newName = document.getElementById('settings-name').value; 
        const newDob = document.getElementById('settings-dob').value; 
        if (newName && newDob) { 
            try { 
                await db.collection('users').doc(currentUser.uid).update({ name: newName, dob: newDob }); 
                alert('Settings saved!'); 
                navigateTo('profile'); 
            } catch (error) { 
                alert('Error: ' + error.message); 
            } 
        } else { 
            alert('Please fill all fields.'); 
        } 
    }); 
    
    // Improved error handling for password change
    document.getElementById('change-password-btn').addEventListener('click', async () => { 
        const currentPass = document.getElementById('current-password').value; 
        const newPass = document.getElementById('new-password').value; 
        if(newPass.length < 6) { 
            alert("New password must be at least 6 characters."); 
            return; 
        } 
        try { 
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass); 
            await auth.currentUser.reauthenticateWithCredential(credential); 
            await auth.currentUser.updatePassword(newPass); 
            alert("Password changed successfully!"); 
            document.getElementById('current-password').value = ''; 
            document.getElementById('new-password').value = ''; 
        } catch (error) { 
            if (error.code === 'auth/wrong-password') {
                alert("Failed: The current password you entered is incorrect.");
            } else {
                alert("Failed: " + error.message); 
            }
        } 
    });
    
    const qrModal = document.getElementById('qr-modal'); 
    const showQrBtn = document.getElementById('show-qr-btn'); 
    const closeQrBtn = document.getElementById('modal-close-btn'); 
    
    showQrBtn.addEventListener('click', () => { 
        generateQRCode(currentUser.userId); 
        document.getElementById('modal-user-id').textContent = currentUser.userId; 
        qrModal.style.display = 'flex'; 
    }); 
    
    const closeModal = () => { 
        qrModal.style.display = 'none'; 
    }; 
    
    closeQrBtn.addEventListener('click', closeModal); 
    qrModal.addEventListener('click', (e) => { 
        if(e.target === qrModal) { 
            closeModal(); 
        } 
    });
    
    function showMessage(element, type, text) { 
        element.className = `message-box ${type}`; 
        element.innerHTML = `<div class="message-icon ${type}"><i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i></div><p>${text}</p>`; 
        element.style.display = 'block'; 
        setTimeout(() => { element.style.display = 'none'; }, 5000); 
    }
    
    function copyToClipboard(text, entityName = 'Text') {
        if (!navigator.clipboard) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`${entityName} copied to clipboard!`);
            } catch (err) {
                alert('Failed to copy text.');
            }
            return;
        }
        navigator.clipboard.writeText(text).then(() => {
            alert(`${entityName} copied: ${text}`);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Could not copy text.');
        });
    }

    
    function generateQRCode(text) { 
        const qrContainer = document.getElementById('modal-qrcode-container'); 
        qrContainer.innerHTML = ''; 
        const qr = qrcode(0, 'L'); 
        qr.addData(text); 
        qr.make(); 
        qrContainer.innerHTML = qr.createImgTag(6, 10); 
    }
    
    // QR Scanner Logic
    function startQrScanner(inputId) {
        activeQrInputId = inputId;
        document.getElementById('qr-scanner-modal').style.display = 'flex';
        html5QrCodeScanner = new Html5Qrcode("qr-reader");
        html5QrCodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess)
        .catch(err => {
            console.error("QR Scanner Error:", err);
            alert("Could not start QR scanner. Please grant camera permission.");
            stopQrScanner();
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
        if (activeQrInputId) {
            document.getElementById(activeQrInputId).value = decodedText;
        }
        stopQrScanner();
    }

    function stopQrScanner() {
        if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
            html5QrCodeScanner.stop().catch(err => console.error("Failed to stop QR Scanner:", err));
        }
        document.getElementById('qr-scanner-modal').style.display = 'none';
        activeQrInputId = null;
    }
    
    document.getElementById('scan-qr-send').addEventListener('click', () => startQrScanner('recipient-id'));
    document.getElementById('scan-qr-out').addEventListener('click', () => startQrScanner('agent-id'));
    document.getElementById('scan-qr-payment').addEventListener('click', () => startQrScanner('payment-id')); // New QR scanner for payment
    document.getElementById('qr-scanner-close-btn').addEventListener('click', stopQrScanner);

    // UPDATED: Function to show confirmation modal with dynamic ID field
    const confirmationModal = document.getElementById('confirmation-modal');

    function showConfirmationPopup(details) {
        const amount = details.amount || 0;
        const fee = details.fee || 0;
        
        document.getElementById('confirm-amount').textContent = `$${amount.toFixed(2)}`;
        document.getElementById('confirm-fee').textContent = `$${fee.toFixed(2)}`;
        document.getElementById('confirm-total').textContent = `$${(amount + fee).toFixed(2)}`;
        document.getElementById('confirm-balance').textContent = `$${details.finalBalance.toFixed(2)}`;
        document.getElementById('confirm-datetime').textContent = new Date().toLocaleString();
        document.getElementById('confirm-tx-id').textContent = details.txId.substring(0, 10) + '...';

        const idRow = document.getElementById('confirm-id-row');
        const idLabel = document.getElementById('confirm-id-label');
        const idValue = document.getElementById('confirm-id-value');

        if (details.idLabel && details.idValue) {
            idLabel.textContent = `${details.idLabel}:`;
            idValue.textContent = details.idValue;
            idRow.style.display = 'flex';
        } else {
            idRow.style.display = 'none';
        }

        const copyBtn = document.getElementById('confirm-copy-btn');
        copyBtn.onclick = () => copyToClipboard(details.txId, 'Transaction ID');

        confirmationModal.style.display = 'flex';
    }

    document.getElementById('confirmation-close-btn').addEventListener('click', () => {
        confirmationModal.style.display = 'none';
    });
    
    </script>
</body>
</html>